pipeline {
    agent any

    parameters {
        choice(name: 'CLUSTER_ENV', 
               choices: ['dev', 'stage', 'prod'], 
               description: 'Which cluster environment to deploy the secret to?')
        
        string(name: 'NAMESPACE', 
               defaultValue: 'app-namespace', 
               description: 'Target Kubernetes namespace')
    }

    environment {
    KUBECONFIG_CRED_ID = "kubeconfig-${params.CLUSTER_ENV}"

        DB_NAME = "db-name-${params.CLUSTER_ENV}"
        DB_USER = "db-user-${params.CLUSTER_ENV}"
        DB_PASS = "db-password-${params.CLUSTER_ENV}"
        DB_HOST = "db-host-${params.CLUSTER_ENV}"
        DB_PORT = "db-port-${params.CLUSTER_ENV}"
        SECRET_KEY = "backend-secret-key-${params.CLUSTER_ENV}"
    }

    stages {
        stage('Apply Secret to Kubernetes') {
            steps {

                withCredentials([
                    file(credentialsId: env.KUBECONFIG_CRED_ID, variable: 'KUBECONFIG'),
                    
                    string(credentialsId: env.DB_NAME, variable: 'DBNAME'),
                    string(credentialsId: env.DB_USER, variable: 'DBUSER'),
                    string(credentialsId: env.DB_PASS, variable: 'DBPASSWORD'),
                    string(credentialsId: env.DB_HOST, variable: 'DBHOST'),
                    string(credentialsId: env.DB_PORT, variable: 'DBPORT'),
                    string(credentialsId: env.SECRET_KEY, variable: 'SECRET_KEY')
                ]) {
                    
                    sh "export KUBECONFIG=\$KUBECONFIG"
                    echo "Applying 'db-credentials' secret to [${params.CLUSTER_ENV}] cluster in namespace [${params.NAMESPACE}]..."

                    sh """
                    kubectl create secret generic db-credentials \\
                      --from-literal=DBNAME="\$DBNAME" \\
                      --from-literal=DBUSER="\$DBUSER" \\
                      --from-literal=DBPASSWORD="\$DBPASSWORD" \\
                      --from-literal=DBHOST="\$DBHOST" \\
                      --from-literal=DBPORT="\$DBPORT" \\
                      --from-literal=SECRET_KEY="\$SECRET_KEY" \\
                      --namespace=${params.NAMESPACE} \\
                      --dry-run=client -o yaml | kubectl apply --validate=false -f -
                    """
                    
                    sh """
                        kubectl get secret db-credentials -n ${params.NAMESPACE}
                        echo "Secret deployed successfully!"
                    """

                }
            }
        }


    }

    post {
        success {
            echo 'Secret deployment completed successfully!'
        }
        failure {
            echo 'Secret deployment failed!'
        }
    }
}